<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="generator" content="pandoc">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="description" content="GGIS on Github : Organization Pages for Gary Dalton and GGIS">

          <meta name="author" content="Gary Dalton">
              <title>Core Pi v2</title>
      <style type="text/css">code{white-space: pre;}</style>
      <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
      <![endif]-->
                  <link rel="stylesheet" href="stylesheets/stylesheet.css">
            </head>

<body>
    
    <div id="header_wrap" class="outer">
    <header class="inner">
                <a id="forkme_banner" href="https://github.com/gary-dalton/RaspberryPi-projects/tree/gh-pages">View on GitHub</a>
                        <h1 id="project_title">Core Pi v2</h1>
                        <h3 id="project_tagline">Pi as a wifi bridge providing safe subnet to wifi and Ethernet</h3>
            </header>
    </div>

    <div id="main_content_wrap" class="outer">
    <section id="main_content" class="inner">
                <p><a href="index.html">Home</a></p>
<section id="description" class="level1">
<h1>Description</h1>
<p>Core Pi v2 joins a pi used as a wifi to eth0 bridge with a spare wifi access point to provide easy setup of new pies. It also provides a local network for working with pies. Core Pi connects to the Internet via wifi, provides a wifi access point, and acts as a DHCP router for a pies direct connected with Ethernet cable.</p>
<p>Recent Raspbian versions are ready for SSH connection over Ethernet cable. Core Pi takes advantage of that to ease initial connection and setup. I am using this in a learning lab environment with Chromebooks.</p>
</section>
<section id="next-up" class="level1">
<h1>Next up?</h1>
<p>After reading this guide, you may be interested in reading:</p>
<ul>
<li><a href="using_core_pi_v2.html">Using CorePi</a></li>
<li><a href="beginner_guide_via_core_pi%20v2.html">Beginner Guide via Core Pi v2</a></li>
</ul>
</section>
<section id="parts-list" class="level1">
<h1>Parts List</h1>
<ul>
<li>Raspberry Pi 2</li>
<li>16GB (or larger) class 10 MicroSD card</li>
<li>USB WiFi</li>
<li>Pi Case</li>
<li>Mini-USB power</li>
<li>Ethernet cable</li>
<li>Wireless router with at least 4 port Ethernet switch
<ul>
<li>I used a spare <a href="http://www.linksys.com/us/p/P-WRT54GL/">Linksys WRT54GL</a></li>
<li>This router already had <a href="https://www.dd-wrt.com">dd-wrt</a> installed.</li>
<li>The specific router and dd-wrt are not required but this guide's instructions may be specific to them</li>
</ul></li>
</ul>
</section>
<section id="overview" class="level1">
<h1>Overview</h1>
<p>Start with a Raspberry Pi image. This is an image saved after following the <a href="rpi_initial_setup.html">RPi Initial Setup Guide</a> and <a href="rpi_gui_changes.html">RPi Desktop Mods</a>. The image should not be Lite. If you do not have such an image, start with a Raspbian image and follow the Initial Setup Guide until reaching <a href="rpi_initial_setup.html#6">Update and upgrade the Pi</a>. Now, jump to <a href="#4">Install Apt-Cacher-NG</a> of this guide before completing the Initial Setup Guide and the Desktop Mods. Once those are completed, return here.</p>
<section id="wireless-router" class="level2">
<h2>Wireless router</h2>
<ol type="1">
<li><a href="#wr1">Reset the router</a></li>
<li><a href="#wr2">Connect to the router</a></li>
<li><a href="#wr3">Router settings - Basic Setup</a></li>
<li><a href="#wr4">Router settings - Wireless Basic Setup</a></li>
<li><a href="#wr5">Router settings - Wireless Security</a></li>
<li><a href="#wr6">Router settings - Apply Settings</a></li>
</ol>
</section>
<section id="pi" class="level2">
<h2>Pi</h2>
<ol type="1">
<li><a href="#1">Write the image to the MicroSD.</a></li>
<li><a href="#2">Connect Pi to the router</a></li>
<li><a href="#3">Connect to your WiFi.</a></li>
<li><a href="#4">Install Apt-Cacher-NG</a></li>
<li><a href="#5">Setup the DHCP server.</a></li>
<li><a href="#6">Set a static IP on eth0.</a></li>
<li><a href="#7">Configure NAT.</a></li>
<li><a href="#8">Shutdown and reconfigure</a></li>
<li><a href="#9">Connect and test.</a></li>
<li><a href="#10">Verify security</a></li>
<li><a href="#Conclusion">Conclusion</a>.</li>
</ol>
</section>
</section>
<section id="procedures-for-wireless-router" class="level1">
<h1>Procedures for wireless router</h1>
<p>The router will serve the subnet of pies but has no Internet access of its own. If you prefer, you may do away with the pi part of this configuration and hook the router up directly to a WAN or broadband modem.</p>
<section id="reset-the-router" class="level2">
<h2><a name="wr1"></a>Reset the router</h2>
<p>Power up the router and then press the reset button on the back of the router. Hold the button for about 20 second or until the power light on the front begins to flash.</p>
<figure>
<img src="images/linksys.jpg" alt="Linksys WRT54GL" /><figcaption>Linksys WRT54GL</figcaption>
</figure>
</section>
<section id="connect-to-the-router" class="level2">
<h2><a name="wr2"></a> Connect to the router</h2>
<p>After a few moments, you should notice a new unsecured wifi access point names dd-wrt. Connect to it.</p>
<p>The router, by default assigns IP addresses in the 192.168.1.0/24 subnet. It also holds the 192.168.1.1 address. Browse to <a href="http://192.168.1.1">192.168.1.1</a>. You are directed to a username and password reset page. Set a secure username and password. For the password, I used the Ownership ID found on the bottom of the router.</p>
</section>
<section id="router-settings---basic-setup" class="level2">
<h2><a name="wr3"></a>Router settings - Basic Setup</h2>
<p>There are only a few settings we need to perform. These include WAN connection, router IP address, DHCP services, WiFi SSID, and WiFi security. See the image for WAN connection, router IP address, and DHCP services settings. Click <em>Save</em> after making the changes.</p>
<figure>
<img src="images/router_basic.png" alt="Router Basic Settings" /><figcaption>Router Basic Settings</figcaption>
</figure>
</section>
<section id="router-settings---wireless-basic-setup" class="level2">
<h2><a name="wr4"></a>Router settings - Wireless Basic Setup</h2>
<p>Here we set the Wireless Mode, SSID, and Channel. Click <em>Save</em> after making the changes.</p>
<figure>
<img src="images/router_wifi_basic.png" alt="Router Basic Settings" /><figcaption>Router Basic Settings</figcaption>
</figure>
</section>
<section id="router-settings---wireless-security" class="level2">
<h2><a name="wr5"></a>Router settings - Wireless Security</h2>
<p>Here we set the Security Mode, the Algorithm, and the shared key. Click <em>Save</em> after making the changes.</p>
<figure>
<img src="images/router_wifi_security.png" alt="Router Basic Settings" /><figcaption>Router Basic Settings</figcaption>
</figure>
</section>
<section id="router-settings---apply-settings" class="level2">
<h2><a name="wr6"></a>Router settings - Apply Settings</h2>
<p>Click <em>Apply Settings</em>. This should cause the router to reboot. If it does not automatically reboot, reboot it manually.</p>
<p>The SSID and IP addresses are changed, therefore; you will need to connect with the new settings. Connect to the SSID, <em>corepiv2</em>, using the shared key, <em>raspberry</em>. Connect to the router at <a href="http://192.168.42.1">192.168.42.1</a>. You should be directed to the status page which provides unprotected general information. To view any other settings page, the username/password is required.</p>
</section>
</section>
<section id="procedures-for-pi" class="level1">
<h1>Procedures for pi</h1>
<p>The pi is needed in this configuration to provide Internet access to the router. The pi gains Internet access by connecting to a wifi access point and NATing eth0 to wlan0.</p>
<section id="write-the-image" class="level2">
<h2><a name="1"></a>Write the image</h2>
<p>Write the image to the MicroSD as described in the <a href="rpi_initial_setup.html">RPi Initial Setup Guide</a>. Insert the MicroSD into the Pi and boot.</p>
</section>
<section id="connect-pi-to-the-router" class="level2">
<h2><a name="2"></a>Connect Pi to the router</h2>
<p>Use an Ethernet cable to connect the pi to the router. DHCP will assign the pi an IP address. This address may be seen at the bottom in the <em>DHCP Clients</em> section of <a href="http://192.168.42.1/Info.htm">router information page</a>.</p>
<ul>
<li>SSH to the pi at that IP address</li>
</ul>
</section>
<section id="connect-the-pi-to-your-wifi-internet" class="level2">
<h2><a name="3"></a>Connect the Pi to your WiFi Internet</h2>
<p>In this guide, I will use the desktop but nmcli may be used as discussed in the <a href="rpi_initial_setup.html#12">RPi Initial Setup Guide - NetworkManager CLI</a>. VNC was discussed in <a href="rpi_initial_setup.html#11">RPi Initial Setup Guide - Connect to the Pi using VNC</a></p>
<p><strong>NOTE: There are many security problems in current vnc implementations. Permit access to vnc servers on the local network only.</strong></p>
<ul>
<li>On the pi, <code>vncserver -nolisten tcp -nevershared -dontdisconnect :1</code></li>
<li>From your browser connect to the pi's VNC</li>
<li>Using the dialogs, connect to your Internet wifi SSID</li>
</ul>
</section>
<section id="install-apt-cacher-ng" class="level2">
<h2><a name="4"></a>Install Apt-Cacher-NG</h2>
<p>Apt-Cacher-NG is a caching proxy server (or apt proxy) for Debian based distributions which caches the downloaded packages locally on your server. This follows the guide from <a href="http://www.tecmint.com/apt-cache-server-in-ubuntu/">Setting up an ‘Apt-Cache’ Server Using ‘Apt-Cacher-NG’ in Ubuntu 14.04 Server</a>. Also, review the <a href="https://www.unix-ag.uni-kl.de/~bloch/acng/html/index.html">Apt-Cacher-NG User Manual</a>.</p>
<ul>
<li>Install, <code>sudo apt-get install apt-cacher-ng</code></li>
<li>Edit the config, <code>sudo nano /etc/apt-cacher-ng/acng.conf</code>
<ul>
<li>Listen only on IPv4, add <code>BindAddress: 0.0.0.0</code></li>
<li>Enable the pid file, <code>PidFile: /var/run/apt-cacher-ng/pid</code></li>
</ul></li>
<li>Restart, <code>sudo service apt-cacher-ng restart</code></li>
<li>Set the current machine to use the cache. Here, the assigned IP is use. It will be changed later after a static IP is assigned to corepi.
<ul>
<li>Get the inet address from <code>ifconfig</code></li>
<li><code>sudo nano /etc/apt/apt.conf.d/02proxy</code></li>
<li>Add <em>Acquire::http { Proxy &quot;http://inet_address:3142&quot;; };</em></li>
</ul></li>
</ul>
<section id="test-apt-cacher-ng" class="level3">
<h3>Test Apt-Cacher-NG</h3>
<p>Browse to <strong>http://inet_address:3142/acng-report.html</strong> to view statistics from apt-cacher-ng.</p>
<p>Now let's perform a system upgrade and see what happens.</p>
<ul>
<li><code>sudo apt-get update</code></li>
<li><code>sudo apt-get upgrade</code></li>
<li>Once the upgrade completes, click <em>Count Data</em> on the statistics page</li>
<li>Also review the log file, <code>less /var/log/apt-cacher-ng/apt-cacher.log</code></li>
</ul>
<p>Apt-Cacher-NG is now prepared to serve cached apt-get requests. Clients must still be informed to use the cache but that will be covered in client configuration.</p>
</section>
</section>
<section id="setup-the-dhcp-server" class="level2">
<h2><a name="5"></a>Setup the DHCP server</h2>
<ul>
<li>Install with, <code>sudo apt-get install isc-dhcp-server</code></li>
<li><code>sudo nano /etc/default/isc-dhcp-server</code></li>
<li><code>INTERFACES=&quot;eth0&quot;</code></li>
<li>Now edit the DHCP configuration file, <code>sudo nano /etc/dhcp/dhcpd.conf</code></li>
</ul>
<pre><code># ADD THE BELOW TO CONFIG FOR ETH0
subnet 192.168.84.0 netmask 255.255.255.0 {
    interface eth0;
    range 192.168.84.10 192.168.84.50;
    option broadcast-address 192.168.84.255;
    option routers 192.168.84.1;
    default-lease-time 600;
    max-lease-time 7200;
    option domain-name &quot;local&quot;;
    option domain-name-servers 8.8.8.8, 8.8.4.4;
}</code></pre>
</section>
<section id="set-a-static-ip-on-eth0" class="level2">
<h2><a name="6"></a>Set a static IP on eth0</h2>
<ul>
<li><code>sudo nano /etc/network/interfaces</code></li>
<li>Comment <code>#iface eth0 inet manual</code></li>
<li>Add</li>
</ul>
<pre><code>iface eth0 inet static
  address 192.168.84.1
  netmask 255.255.255.0</code></pre>
</section>
<section id="configure-nat" class="level2">
<h2><a name="7"></a>Configure NAT</h2>
<ul>
<li>Enable IP Forwarding
<ul>
<li><code>sudo nano /etc/sysctl.conf</code> at bottom add <em>net.ipv4.ip_forward=1</em></li>
<li><code>sudo sh -c &quot;echo 1 &gt; /proc/sys/net/ipv4/ip_forward&quot;</code></li>
</ul></li>
<li>If you have not already completed [Firewall with iptables]((rpi_initial_setup.html#10), do so now</li>
<li>Update iptables rules, <code>sudo nano /etc/iptables.test.rules</code></li>
<li>Update the file to this:</li>
</ul>
<pre><code>*nat

# Allow Access Point NAT
-A POSTROUTING -o wlan0 -j MASQUERADE

# For Coder access
#-A PREROUTING -p tcp -m tcp --dport 8080 -j REDIRECT --to-ports 8080
#-A PREROUTING -p tcp -m tcp --dport 8081 -j REDIRECT --to-ports 8081

# Force all SSH to stay on Core Pi
-A PREROUTING -p tcp -m tcp --dport 22 -j REDIRECT --to-ports 22

COMMIT

*filter

# Allows all loopback (lo0) traffic and drop all traffic to 127/8 that
# doesn&#39;t use lo0
-A INPUT -i lo -j ACCEPT
-A INPUT ! -i lo -d 127.0.0.0/8 -j REJECT

# Accepts all established inbound connections
#-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Allows all outbound traffic
# You could modify this to only allow certain traffic
-A OUTPUT -j ACCEPT

# Allows HTTP and HTTPS connections from anywhere (the normal ports
# for websites)
-A INPUT -p tcp --dport 80 -j ACCEPT
-A INPUT -p tcp --dport 443 -j ACCEPT
# Coder
#-A INPUT -p tcp --dport 8080 -j ACCEPT
#-A INPUT -p tcp --dport 8081 -j ACCEPT

# Allows SSH connections
# The --dport number is the same as in /etc/ssh/sshd_config
-A INPUT -p tcp -m state --state NEW --dport 22 -j ACCEPT

# Limit SSH abuse
# The first rule records the IP address of each new attempt to access
# port 22 using the recent module. The second rule checks to see if that
# IP address has attempted to connect 4 or more times within the last
# 60 seconds, and if not then the packet is accepted.
-A INPUT -p tcp -m state --state NEW -m recent --dport 22 --set --name ssh --rsource
-A INPUT -p tcp -m state --state NEW -m recent --dport 22 ! --rcheck --seconds 60 --hitcount 4 --name ssh --rsource -j ACCEPT

# Allows vncserver connections. Uncomment this to allow VNC. Again, this is
# best restricted to certain IPs
-A INPUT -p tcp -m state --state NEW --dport 5901 -j ACCEPT

# Allow Zeroconf connections. (Bonjour and Avahi)
#-A INPUT -p udp -m state --state NEW --dport 5353 -j ACCEPT

# Allow ping
# note that blocking other types of icmp packets is considered a bad idea
# by some
#  remove -m icmp --icmp-type 8 from this line to allow all kinds of icmp:
#  https://security.stackexchange.com/questions/22711
-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT

# Allow forwarded from wlan1 to permit NAT and Access Point
#-A FORWARD -i wlan0 -o wlan1 -m state --state RELATED,ESTABLISHED -j ACCEPT
#-A FORWARD -i wlan1 -o wlan0 -j ACCEPT

# Allow forwarded from eth0 to permit NAT and Core Pi
-A FORWARD -i wlan0 -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i eth0 -o wlan0 -j ACCEPT

# log iptables denied calls (access via &#39;dmesg&#39; command)
-A INPUT -m limit --limit 5/min -j LOG --log-prefix &quot;iptables denied: &quot; --log-level 7

# Reject all other inbound - default deny unless explicitly allowed policy:
-A INPUT -j DROP
-A FORWARD -j DROP

COMMIT</code></pre>
<ul>
<li>Load the rules, <code>sudo iptables-restore &lt; /etc/iptables.test.rules</code></li>
<li>Verify rules, <code>sudo iptables -L</code>, <code>sudo iptables -S</code>, <code>sudo iptables -S -t nat</code></li>
<li>Save rules for booting,</li>
</ul>
<pre><code>sudo -i
iptables-save &gt; /etc/iptables.up.rules
exit</code></pre>
</section>
<section id="shutdown-and-reconfigure" class="level2">
<h2><a name="8"></a>Shutdown and reconfigure</h2>
<p>Now the Core Pi v2 must be shutdown and physically reconfigured. If some of the pi settings are incorrect, you may have to connect to it using a console cable unless the wifi automatically connects to an access point.</p>
<ul>
<li><code>sudo shutdown now</code></li>
<li>Remove power</li>
<li>Connect the Ethernet cable from the pi to the WAN port on the router</li>
<li>Boot up the pi</li>
</ul>
</section>
<section id="connect-and-test" class="level2">
<h2><a name="9"></a>Connect and Test</h2>
<p>Connect to the SSID corpiv2 and browse to the <a href="http://192.168.42.1/Info.htm">router information page</a>. You should notice a WAN IP in the 192.168.84.0/24 subnet and LAN IP of 192.168.42.1. The IP address of the pi is <em>192.168.84.1</em>.</p>
<ul>
<li>Connect to the pi using an SSH session with <em>192.168.84.1</em>
<ul>
<li>If this fails, check your network connections. If the wifi to corepiv2 is not the only connection then maybe the OS is trying to route through the other connection. Disconnect the other connections.</li>
</ul></li>
<li>On the pi, <code>vncserver -nolisten tcp -nevershared -dontdisconnect :1</code></li>
<li>Connect to VNC at <em>192.168.84.1:1</em></li>
<li>If not already connected, connect the pi to your wifi access point.</li>
<li>Once connected to wifi, disconnect VNC and kill the service, <code>vncserver -kill :1</code>.</li>
</ul>
<p>If SSH and VNC connected properly, well done. Otherwise, begin some troubleshooting.</p>
</section>
<section id="verify-security" class="level2">
<h2><a name="10"></a>Verify security</h2>
<p>Core Pi may be accessed as a via point for novices. Novices should not gain shell or VNC access.</p>
<ul>
<li>The pi user should have a strong password. If it is not, change it now with <code>sudo raspiconfig</code>.</li>
<li>Use SSH key authentication. This was covered in <a href="rpi_initial_setup.html#9">SSH key authentication</a></li>
<li>Set a strong password for VNC
<ul>
<li>If you need to change the VNC password, simply <code>rm .vnc/passwd</code></li>
</ul></li>
<li>Once the pi is connedted to wifi, <code>vncserver -kill :1</code></li>
</ul>
</section>
</section>
<section id="conclusion" class="level1">
<h1><a name="Conclusion"></a>Conclusion</h1>
<p>CorePiv2 is ready to use for serving as a wifi router, network master, and pi setup station. It would be relatively easy to write some scripts to automatically set up any unconfigured pi connected to eth0. I do not plan on writing such scripts since my CorePi will be used in learning how to set up a pi.</p>
<p>Remember to save your image file as CorePi.</p>
</section>
            </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
    <footer class="inner">
        <p>Published with <a href="http://pandoc.org/">Pandoc</a> onto
        <a href="https://pages.github.com">GitHub Pages</a></p>
    </footer>
    </div>

</body>
</html>
