<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="generator" content="pandoc">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <meta name="description" content="GGIS on Github : Organization Pages for Gary Dalton and GGIS">

          <meta name="author" content="Gary Dalton">
              <meta name="dcterms.date" content="2016-01-23">
          <title>RPi Initial Setup Guide</title>
      <style type="text/css">code{white-space: pre;}</style>
      <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
      <![endif]-->
                  <link rel="stylesheet" href="stylesheets/stylesheet.css">
            </head>

<body>
    
    <div id="header_wrap" class="outer">
    <header class="inner">
                <a id="forkme_banner" href="https://github.com/gary-dalton/RaspberryPi-projects/tree/gh-pages">View on GitHub</a>
                        <h1 id="project_title">RPi Initial Setup Guide</h1>
                        <h3 id="project_tagline">Raspberry Pi - Image and Initial Setup</h3>
            </header>
    </div>

    <div id="main_content_wrap" class="outer">
    <section id="main_content" class="inner">
                <section id="description" class="level1">
<h1>Description</h1>
<p>This guides the user through creation of a MicroSD image and then initial setup of the Raspberry Pi. It is necessary to have either a wired or WiFi network to complete this guide. Once a well functioning and secure Pi is completed, the user will save the image. Notice that a large part of this guide deals with security. Security is a primary concern when connecting things to the Internet.</p>
</section>
<section id="next-up" class="level1">
<h1>Next up?</h1>
<p>After reading this guide, you may be interested in reading:</p>
<ul>
<li><a href="rpi_wifi_ap.html">RPi WiFi Access Point Guide</a></li>
<li><a href="rpi_tor.html">Raspberry Tor</a></li>
<li><a href="rpi_gui_changes.html">RPi Desktop Mods</a>, Changes to the packages and defaults of the full Raspian</li>
</ul>
</section>
<section id="parts-list" class="level1">
<h1>Parts List</h1>
<ul>
<li>Raspberry Pi 2</li>
<li>4GB (or larger) class 10 MicroSD card</li>
<li><a href="http://www.amazon.com/Edimax-EW-7811Un-150Mbps-Raspberry-Supports/dp/B003MTTJOY/ref=pd_bxgy_147_2">USB WiFi dongle</a> <em>(optional)</em></li>
<li><a href="https://www.adafruit.com/product/954">USB to serial console cable</a> <em>(optional)</em></li>
</ul>
</section>
<section id="overview" class="level1">
<h1>Overview</h1>
<ol type="1">
<li><a href="#1">Download the Raspbian image and write it to the microSD.</a></li>
<li><a href="#2">Connect to the Pi.</a></li>
<li><a href="#3">Boot the Pi.</a></li>
<li><a href="#4">Run the initial setup.</a></li>
<li><a href="#5">Connect to the Internet.</a></li>
<li><a href="#6">Update and upgrade the Pi.</a></li>
<li><a href="#7">Install some network magic.</a></li>
<li><a href="#8">Connect to the Pi using SSH.</a></li>
<li><a href="#9">Improving security.</a></li>
<li><a href="#10">Firewalling with iptables.</a></li>
<li><a href="#11">Connect to the Pi using VNC.</a> <em>(optional)</em></li>
<li><a href="#12">Advanced network management with nmcli.</a> <em>(optional)</em></li>
<li><a href="#13">Add the Adafruit Raspberry Pi repository.</a> <em>(optional)</em></li>
<li><a href="#14">Install node.js.</a> <em>(optional)</em></li>
<li><a href="#15">Install occidentalis.</a> <em>(optional)</em></li>
<li><a href="#Conclusion">Conclusion</a>.</li>
</ol>
<p>The estimated time to complete each step is given. This time is for a novice performing the procedures for the first time. If you are familiar with some of the topics or have completed these procedures before, you should expect to use less time.</p>
<p>Not sure where things are on your Pi? Review <a href="http://www.techweekeurope.co.uk/wp/wp-content/gallery/raspberry-pi-b/b__infographic_web.jpg">this diagram</a>.</p>
</section>
<section id="procedures" class="level1">
<h1>Procedures</h1>
<section id="raspbian" class="level2">
<h2><a name="1"></a>Raspbian</h2>
<p><em>Time to complete this is about 1 hour 20 minutes. If you already have an image, the required software, and have done it before it will go much faster.</em></p>
<p>Download the <a href="https://www.raspberrypi.org/downloads/raspbian/">latest version of Raspbian</a>. For general use, download the full version. If you are certain that you want a headless installation with no GUI desktop, download the Lite version. I usually use the Lite version with no desktop.</p>
<p>For the Lite version, a 4Gb MicroSD is likely sufficient but use at least an 8GB card for the full version. The required size of your disk depends a bit on your expected use. In early 2016, the sweet spot in pricing for these cards is 16GB.</p>
<p>Unzip the image and write it to the MicroSD card. On Windows, I use <a href="http://sourceforge.net/projects/win32diskimager/">Win32 Disk Imager</a>. More detailed instructions and instructions for other operating systems may be found on <a href="https://www.raspberrypi.org/documentation/installation/installing-images/README.md">Raspberrypi.org's Installing Images</a>.</p>
<p>Insert the MicroSD into the Pi.</p>
<hr />
</section>
<section id="connect-to-the-pi" class="level2">
<h2><a name="2"></a>Connect to the Pi</h2>
<p><em>Time to complete is about 15 minutes.</em></p>
<p>From the initial boot, there are three ways to connect to the pi.</p>
<ol type="1">
<li>A Raspberry Pi is a computer that may be operated by connecting with a mouse, keyboard, and monitor.</li>
<li>Using SSH over an Ethernet connection. If you are not familiar with SSH, we will review it later in this guide.</li>
<li>Often, I find it easiest to connect to it using the USB to Serial console cable. This allows me to use my main computer's equipment while working on the Pi in a terminal window. See the <a href="https://learn.adafruit.com/adafruits-raspberry-pi-lesson-5-using-a-console-cable">Adafruit overiew</a> for full details on using the USB to console cable.
<ul>
<li>If you use the Adafruit guide and wish to install PuTTY, this <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html">PuTTY page</a> instead. Also, don't download just the putty.exe but the <strong>A Windows installer for everything except PuTTYtel</strong> instead.</li>
</ul></li>
</ol>
<figure>
<img src="images/USB-console-connect.jpg" alt="USB to console connection" /><figcaption>USB to console connection</figcaption>
</figure>
<hr />
</section>
<section id="boot-the-pi" class="level2">
<h2><a name="3"></a>Boot the Pi</h2>
<p><em>Time to complete is about 5 minutes.</em></p>
<p>As soon as you insert the USB to console cable into your computer, the Pi will start to boot. If you are using a keyboard and monitor, plug in your power to boot the Pi.</p>
<p>This next set of instructions assumes you are using the USB to console cable.</p>
<ol type="1">
<li>Use PuTTY to connect to the serial COM port of the USB connection</li>
<li>Hit enter to show the login screen</li>
<li>Login using the default user: pi and the default password: raspberry. (We will change these shortly.)</li>
</ol>
<p><strong>Hint</strong>, putty allows easy copy/paste. To copy from the putty session to the clipboard, just highlight the required text using the mouse. To paste into the putty session from the clipboard, press the <em>Shift and Insert</em> keys.</p>
<hr />
</section>
<section id="run-first-boot-setup" class="level2">
<h2><a name="4"></a>Run first boot setup</h2>
<p><em>Time to complete is about 10 minutes.</em></p>
<p>Start the configuration software to expand the filesystem, change the password, and change the hostname. Enter the configuration with this command, <code>sudo raspi-config</code>.</p>
<ul>
<li>Select and execute <strong>Expand Filesystem</strong></li>
<li>Select and execute <strong>Change User Password</strong></li>
<li>Select and execute <strong>Internationalization Options</strong>
<ul>
<li><strong>Change Locale</strong> to your locale. Mine is en_US.UTF.</li>
<li><strong>Change Timezone</strong> to UTC.</li>
</ul></li>
<li>Select <strong>Advanced Options</strong> and select and execute <strong>Hostname</strong>. <em>Pick a unique and easy to remember hostname. This will be used to connect later.</em></li>
<li>Reboot your system <code>sudo reboot now</code>.</li>
</ul>
<p><strong>The pi may be shutdown from the command line with, <code>sudo shutdown now</code>. Wait about a minute and remove power.</strong></p>
<hr />
</section>
<section id="connect-to-the-internet" class="level2">
<h2><a name="5"></a>Connect to the Internet</h2>
<p><em>Time to complete is about 40 minutes.</em></p>
<section id="ethernet" class="level3">
<h3>Ethernet</h3>
<p>The easiest way to do this is via Ethernet. Check if you are connected with <code>ifconfig eth</code>. From this output, make note of the <strong>inet addr</strong>. This is your Pi's IP address.</p>
</section>
<section id="wifi" class="level3">
<h3>WiFi</h3>
<p>If you do not have an Ethernet connection, you will have to set up your wifi. This procedure assumes you are using a supported wifi USB dongle, are connecting to a simple shared key access point using DHCP, and are not using the GUI desktop to configure your connections. If you are using the full desktop, connect your wifi using the graphical Network Manager. See the <a href="https://wiki.debian.org/WiFi">Debian wiki</a> for an excellent discussion.</p>
<ul>
<li>Before connecting any USB dongle, shutdown the pi</li>
<li><code>sudo nano /etc/network/interfaces</code></li>
<li>Find the section within this file starting with <code>allow hotplug wlan0</code>. Replace that section with the following.</li>
</ul>
<pre><code>auto wlan0
allow-hotplug wlan0
iface wlan0 inet dhcp
    wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf</code></pre>
<ul>
<li><code>CTRL-o</code> to save and <code>CTRL-x</code> to exit.</li>
<li><code>sudo nano /etc/wpa_supplicant/wpa_supplicant.conf</code></li>
<li>Add the following to this file (remember to change replace <em>your_wifi_identifier</em> and <em>your_wifi_password</em> with your real values):</li>
</ul>
<pre><code>network={
ssid=&quot;your_wifi_identifier&quot;
psk=&quot;your_wifi_password&quot;
proto=RSN
key_mgmt=WPA-PSK
pairwise=CCMP
auth_alg=OPEN
}</code></pre>
<ul>
<li>Try continuing with these setting but make note that you may need to change the <em>proto</em> or <em>key mgmt</em> values depending on your network. See <code>man wpa_supplicant.conf</code> for more information.</li>
<li>Restart the wifi interface. If your settings are correct, it should automatically connect.</li>
</ul>
<pre><code>sudo ifdown wlan0
sudo ifup wlan0</code></pre>
<ul>
<li>Check that you are connected with <code>ifconfig wlan0</code>. From this output, make note of the <strong>inet addr</strong>. This is your Pi's IP address. Use <code>iwconfig wlan0</code> to see which Access Point you are connected to.</li>
</ul>
<hr />
</section>
</section>
<section id="update-and-upgrade" class="level2">
<h2><a name="6"></a>Update and upgrade</h2>
<p><em>Time to complete is about 5 minutes. This does not include the amount of time required to upgrade. Upgrading your system may take an hour with a slow connection and many upgrades.</em></p>
<p>It is important to keep your pi's software up to date. This is commonly done using apt-get. The main keywords to know are <em>update</em>, <em>upgrade</em>, <em>install</em>, and <em>remove</em>. So let's make the system current.</p>
<ul>
<li>Update the packages list, <code>sudo apt-get update</code>.</li>
<li>Upgrade software packages to the current version, <code>sudo apt-get upgrade</code>.</li>
<li>Relax, this might take a while. Maybe grab lunch.</li>
</ul>
<hr />
</section>
<section id="network-magic" class="level2">
<h2><a name="7"></a>Network magic</h2>
<p><em>Time to complete is about 5 minutes.</em></p>
<p>This step does nothing more than make it easier to find your Pi on your network. It uses <em>Zeroconf</em>, provided by <em>Avahi</em> on Linux, <em>Bonjour</em> on Windows, and included in Apple.</p>
<ol type="1">
<li>Install <code>sudo apt-get install avahi-daemon</code>. (<strong>Note,</strong> on recent versions of Raspbian this is already installed and working.)</li>
<li>Your system can now be found at hostname.local, where the hostname is that which you entered back in <em><a href="#4">Run first boot setup</a></em>.</li>
<li>For your Windows machine, download and install <a href="https://support.apple.com/downloads/Bonjour_for_Windows">Bonjour Print Services</a>.</li>
</ol>
<hr />
</section>
<section id="connect-to-pi-using-ssh" class="level2">
<h2><a name="8"></a>Connect to Pi using SSH</h2>
<p><em>Time to complete is about 30 minutes.</em></p>
<p>SSH is a safe and efficient way to connect to your Pi over the network or the Internet. It is enabled by default but for highest security, I recommend a few configuration changes and installing your own personal keys. This guide assumes you are connecting from Windows or another Linux system. For Windows use <a href="http://www.putty.org/">PuTTY</a> and for Linux use <a href="http://www.openssh.com/">OpenSSH</a>. It may be necessary to install PuTTY but OpenSSH comes installed on Linux.</p>
<ul>
<li>Verify that SSH is enabled, <code>sudo raspi-config</code> then Advanced Options and then SSH. (<strong>Note,</strong> on recent versions of Raspbian this is enabled by default.)</li>
</ul>
<section id="browser" class="level3">
<h3>Browser</h3>
<p>If you are using the Chrome browser, there is an app that makes SSH easy. Add to Chrome by visiting the <a href="https://chrome.google.com/webstore/detail/secure-shell/pnhechapfaindjhompbnflcldabbghjo">Web Store</a>. Once installed, launch it from the <a href="chrome://apps/">apps page</a>.</p>
<ul>
<li>Select a <em>New connection</em></li>
<li>In the free form text box enter a name for your pi connection. I usually give it the same name as my pi.</li>
<li>Username is the user to connect to your pi as. Default it <em>pi</em></li>
<li>Hostname is <em>hostname.local</em> or the IP address you made note of earlier.</li>
<li>Port is 22</li>
<li>Click <em>Connect</em></li>
<li>When done <code>exit</code></li>
</ul>
</section>
<section id="windows" class="level3">
<h3>Windows</h3>
<ol type="1">
<li>Start puTTY</li>
<li>Enter <em>hostname.local</em>, where hostname is from <em>Network magic</em> into the <strong>Host Name (or IP address)</strong> box.
<ul>
<li>If you are not able to connect with <em>hostname.local</em>, try connecting using the IP address instead. If this works, then somehow the network magic is being blocked.</li>
</ul></li>
<li>Save the session if you wish.</li>
<li>The first time you connect, you will get an alert. Click Yes to continue.</li>
<li>Enter your username, default <em>pi</em>, and password.</li>
<li>You are now at the CLI prompt of your pi.</li>
<li>When done, end your session with <code>exit</code>.</li>
</ol>
</section>
<section id="linux" class="level3">
<h3>Linux</h3>
<ol type="1">
<li>Connect using <code>ssh user@hostname.local</code>, where hostname is from <em>6 Network magic</em> and the default user is <em>pi</em>.</li>
<li>The first time you connect, you will get an alert. Enter <strong>yes</strong> to continue.</li>
<li>You are now at the CLI prompt of your pi.</li>
<li>When done, end your session with <code>exit</code>.</li>
</ol>
<p>A good resource is from <a href="https://wiki.archlinux.org/index.php/Secure_Shell">archlinux</a>.</p>
<hr />
</section>
</section>
<section id="improving-security" class="level2">
<h2><a name="9"></a>Improving security</h2>
<p>Some general rules to security are:</p>
<ul>
<li>Do not use default passwords</li>
<li>Use multifactor authentication</li>
<li>Do not provide shell access unless it is needed</li>
<li>Do not provide services you do not need</li>
<li>Do not needlessly expose services</li>
<li>Apply security patches</li>
<li>Prevent physical access</li>
<li>Use quality cryptology</li>
</ul>
<section id="sshd-configuration" class="level3">
<h3>SSHd configuration</h3>
<p><em>Time to complete is about 5 minutes.</em></p>
<p>There are a few SSHd configuration changes that will improve SSH security. Since SSHd is likely a service you do want to provide and it gives shell access, this is important.</p>
<ul>
<li>Edit the configuration file, <code>sudo nano /etc/ssh/sshd_config</code></li>
<li><p>Change the following:</p>
<pre><code>PermitRootLogin no</code></pre></li>
<li><p>Add the following:</p>
<pre><code>AllowUsers pi
# Even better if you use a non-default user</code></pre></li>
</ul>
</section>
<section id="ssh-key-authentication-advanced" class="level3">
<h3>SSH key authentication (advanced)</h3>
<p>Using public key authentication will greatly improve your SSHd security but sometimes seems complicated. Do it anyways.</p>
<section id="linux-1" class="level4">
<h4>Linux</h4>
<ol type="1">
<li>Generate a password protected key pair, <code>ssh-keygen</code>.</li>
<li><p>You will be asked the name of the key file and the password to unlock the key. I usually name my key file according to the system it is used to connect to. The process should look something like this:</p>
<pre><code>Generating public/private rsa key pair.
Enter file in which to save the key (/home/user/.ssh/id_rsa): /home/user/.ssh/id_rsa_hostname
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/user/.ssh/id_rsa_hostname.
Your public key has been saved in /home/user/.ssh/id_rsa_hostname.pub.
The key fingerprint is:
ac:6a:0f:32:2e:bd:aa:3d:46:cc:c0:21:cc:68:47:40 user@computer
The key&#39;s randomart image is:
+---[RSA 2048]----+
|=Eo.             |
|o= .             |
|+ o              |
|..     .         |
| +      S        |
|  +    .         |
| oo . .          |
|.o+o.o           |
|++++...          |
+-----------------+</code></pre></li>
<li>Copy your public key to the pi, <code>ssh-copy-id -i ~/.ssh/id_rsa_hostname.pub pi@hostname.local</code>.</li>
<li><p>You should see something like the following and also be asked for your password.</p></li>
</ol>
<pre><code>/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
pi@hostname.local&#39;s password:

Number of key(s) added: 1

Now try logging into the machine, with:   &quot;ssh &#39;pi@hostname.local&#39;&quot;
and check to make sure that only the key(s) you wanted were added.</code></pre>
<ul>
<li>Go ahead and <code>ssh 'pi@hostname.local</code>. You should be asked for the password for your key.</li>
</ul>
<p>An excellent resource for learning more is from <a href="https://wiki.archlinux.org/index.php/SSH_keys">archlinux</a></p>
</section>
<section id="windows-putty" class="level4">
<h4>Windows PuTTY</h4>
<ol type="1">
<li>Start <strong>PuTTYgen</strong></li>
<li>Change the <em>Number of bits in a generated key</em> to 2048.</li>
<li>Click <strong>Generate</strong> to generate a new key pair.</li>
<li>Add a password to the <em>Key passphrase</em> and <em>Confirm passphrase</em>.</li>
<li>Save your public and private keys. The private key should not be shared but the public key may be freely shared.</li>
<li>On the pi,
<ul>
<li><code>mkdir ~/.ssh</code></li>
<li><code>nano ~/.ssh/authorized_keys</code>.</li>
</ul></li>
<li>Copy the public key from the Windows PuTTYgen box and paste it into the authorized_keys file on your pi. Save the file.</li>
<li>Close PuTTYgen.</li>
<li>Open PuTTY.</li>
<li>Save a new session named <em>hostname</em> and put <em>hostname.local</em> in the Host Name box.</li>
<li>From the configuration Categories, select Connection &gt;&gt; SSH &gt;&gt; Auth.</li>
<li>Browse to select the private key you created earlier for authentication.</li>
<li>Save the session.</li>
<li>Test by clicking Open.</li>
<li>You should be required to enter in the username to log in with and also the password used to protect the key.</li>
</ol>
<p><strong>NOTE: Do not lose your private keys. Once the next configuration steps are complete, your private key and password are required to login remotely.</strong> You will still be able to login from the console or with a keyboard and monitor.</p>
</section>
</section>
<section id="more-sshd-configuration-advanced" class="level3">
<h3>More SSHd configuration (advanced)</h3>
<p>Time now to only allow remote logins using public key authentication. This configuration is on your pi.</p>
<ol type="1">
<li>Open the file, <code>sudo nano /etc/ssh/sshd_config</code></li>
<li><p>Add the following lines to the file and save:</p>
<pre><code>PasswordAuthentication no
ChallengeResponseAuthentication no
UsePAM no
PubkeyAuthentication yes</code></pre></li>
<li>Reload the sshd configuration, <code>sudo service sshd reload</code></li>
<li><p>Test by trying to login without the key file.</p></li>
</ol>
<hr />
</section>
</section>
<section id="firewall-with-iptables-advanced" class="level2">
<h2><a name="10"></a>Firewall with iptables (advanced)</h2>
<p>At this point, your pi is functional, connected, and reasonably secure. It can be made more secure with iptables which will only allow the types of traffic you permit. Iptables is currently running on your pi but it is set to allow all traffic. We are about to change that. Rules for iptables can sometimes be a bit touchy so make certain that you are able to connect to your pi via console until certain of your settings. Iptables is quite powerful but also sometimes complex, so do try to learn more before blindly applying these rules. See <a href="https://help.ubuntu.com/community/IptablesHowTo/">Iptables How To</a>, <a href="https://wiki.debian.org/iptables">Debian</a>, and <a href="https://wiki.archlinux.org/index.php/iptables">archlinux</a>.</p>
<p>Firewall rules are processed from top to bottom. Once a rule is matched, no more rule checking occurs. So if my first rule allows all traffic and my last rule allows none, then all traffic is allowed. Don't block yourself by creating a bad first rule.</p>
<ol type="1">
<li>List current rules, <code>sudo iptables -L</code></li>
<li>Store rules in a file, <code>sudo apt-get install iptables-persistent</code></li>
<li>Edit the files, <code>sudo nano /etc/iptables.test.rules</code></li>
<li>Add the following to this file:</li>
</ol>
<pre><code>*filter

# Allows all loopback (lo0) traffic and drop all traffic to 127/8 that
# doesn&#39;t use lo0
-A INPUT -i lo -j ACCEPT
-A INPUT ! -i lo -d 127.0.0.0/8 -j REJECT

# Accepts all established inbound connections
#-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Allows all outbound traffic
# You could modify this to only allow certain traffic
-A OUTPUT -j ACCEPT

# Allows HTTP and HTTPS connections from anywhere (the normal ports
# for websites)
-A INPUT -p tcp --dport 80 -j ACCEPT
-A INPUT -p tcp --dport 443 -j ACCEPT

# Allows SSH connections
# The --dport number is the same as in /etc/ssh/sshd_config
-A INPUT -p tcp -m state --state NEW --dport 22 -j ACCEPT

# Limit SSH abuse
# The first rule records the IP address of each new attempt to access
# port 22 using the recent module. The second rule checks to see if that
# IP address has attempted to connect 4 or more times within the last
# 60 seconds, and if not then the packet is accepted.
-A INPUT -p tcp -m state --state NEW -m recent --dport 22 --set --name ssh --rsource
-A INPUT -p tcp -m state --state NEW -m recent --dport 22 ! --rcheck --seconds 60 --hitcount 4 --name ssh --rsource -j ACCEPT

# Now you should read up on iptables rules and consider whether ssh access
# for everyone is really desired. Most likely you will only allow access
# from certain IPs.

# Allows TightVNC connections. Uncomment this to allow VNC. Again, this is
# best restricted to certain IPs
#-A INPUT -p tcp -m state --state NEW --dport 5901 -j ACCEPT

# Allow Zeroconf connections. (Bonjour and Avahi)
-A INPUT -p udp -m state --state NEW --dport 5353 -j ACCEPT

# Allow ping
# note that blocking other types of icmp packets is considered a bad idea
# by some
#  remove -m icmp --icmp-type 8 from this line to allow all kinds of icmp:
#  https://security.stackexchange.com/questions/22711
-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT

# log iptables denied calls (access via &#39;dmesg&#39; command)
-A INPUT -m limit --limit 5/min -j LOG --log-prefix &quot;iptables denied: &quot; --log-level 7

# Reject all other inbound - default deny unless explicitly allowed policy:
-A INPUT -j DROP
-A FORWARD -j DROP

COMMIT</code></pre>
<ol start="5" type="1">
<li>Load the rules, <code>sudo iptables-restore &lt; /etc/iptables.test.rules</code>.</li>
<li>Check that they loaded correctly, <code>sudo iptables -L</code>.</li>
<li>Verify that you can still establish a connection using SSH.</li>
<li>All OK? Save the rules, <code>sudo iptables-save &gt; /etc/iptables.up.rules</code>.</li>
<li>Force rules to load on reboot, <code>sudo nano /etc/network/if-pre-up.d/iptables</code>.</li>
<li><p>Add these lines:</p>
<pre><code>#!/bin/sh
/sbin/iptables-restore &lt; /etc/iptables.up.rules</code></pre></li>
<li>Make that file executable, <code>sudo chmod +x /etc/network/if-pre-up.d/iptables</code>.</li>
<li><p>Reboot and test by connecting with SSH and <code>iptables -L</code>.</p></li>
</ol>
<hr />
</section>
<section id="connect-to-the-pi-using-vnc" class="level2">
<h2><a name="11"></a>Connect to the Pi using VNC</h2>
<p><em>Time to complete is about 20 minutes.</em></p>
<p>(optional) Virtual Network Connection (VNC) is a way to remotely connect to your pi via the network and access the pi's GUI desktop. I usually do not use a VNC but there are circumstances (educational setting, inexperienced users) where it does prove useful. Generally, I connect using the Browser method. Good information from <a href="https://www.raspberrypi.org/documentation/remote-access/vnc/">rasperrypi.org</a>.</p>
<p><strong>Note: VNC should only available on the local network.</strong></p>
<p>If you feel you need to run an Internet accessible VNC Server, at a minimum, use SSH tunneling for all connections.</p>
<ol type="1">
<li>Update your sources, <code>sudo apt-get update</code>.</li>
<li>Install TightVNC Server, <code>sudo apt-get install tightvncserver</code>.</li>
<li>Start the server, <code>vncserver :1</code>.</li>
<li>Enter the requested new vnc password. This will be required from the VNC Viewer we install later.</li>
<li>Stop the server with <code>vncserver -kill :1</code>.</li>
<li>The vncserver may be setup to run at boot but I do not recommend it.</li>
<li>Update the iptables rule if needed. (this is from <em>Firewall with iptables (advanced)</em>)</li>
</ol>
<section id="connect-from-linux" class="level3">
<h3>Connect from Linux</h3>
<ul>
<li>From the desktop open either <em>Remote Desktop Viewer</em> or the <em>Remmina Remote Desktop Client</em>.
<ul>
<li><code>sudo apt-get install remmina</code></li>
</ul></li>
<li>Change the connection protocol to VNC.</li>
<li>Connect to <em>hostname.local:1</em>.</li>
<li>Enter the vnc password.</li>
<li>When done, just close the window.</li>
</ul>
</section>
<section id="connect-from-a-browser" class="level3">
<h3>Connect from a browser</h3>
<p>Browser based VNC makes it easy for anyone to use this technology. I use the Google Chrome App from <a href="https://www.realvnc.com/products/chrome/">RealVNC</a>.</p>
<ul>
<li>From the RealVNC page click <em>available in the chrome web store</em></li>
<li>Add to Chrome</li>
<li>Launch the extension from Chrome Apps</li>
<li>Enter the address, <em>hostname.local:1</em></li>
<li>Click <em>Connect</em></li>
<li>Enter the vnc password.</li>
<li>When done, just close the window.</li>
</ul>
</section>
<section id="connect-from-windows" class="level3">
<h3>Connect from Windows</h3>
<ol type="1">
<li>Download the <a href="http://www.tightvnc.com/download.php">TightVNC installer</a>.</li>
<li>Start the installer and choose <strong>Custom Setup</strong>.</li>
<li>From Custom Setup, use the pull-down next to TightVNC Server to have <strong>Entire feature will be unavailable</strong>.</li>
<li>Start the <em>Tight VNC Viewer</em>.</li>
<li>Connect to the Remote Host, <em>hostname.local:1</em>.</li>
<li>When done, just close the window.</li>
</ol>
<hr />
</section>
</section>
<section id="networkmanager-cli-advanced" class="level2">
<h2><a name="12"></a>NetworkManager CLI (advanced)</h2>
<p>If the Pi will be used from the GUI destop or if it just needs to connect to one network and won't be moving around much, you don't need Network Manager. If you are likely to go mobile with your Pi and need to connect to multiple networks, consider using nmcli.</p>
<p>NetworkManager is a set of tools that make networking simpler. Whether Wi-Fi, wired, bond, bridge, 3G, or Bluetooth, NetworkManager allows you to quickly move from one network to another: once a network has been configured and joined, it can be detected and re-joined automatically the next time its available. Nmcli is just the command line interface, CLI, to NetworkManager.</p>
<p><strong>This procedure will disable your wifi connection until it is reestablished in NetworkManager. So you will need a console or Ethernet connection.</strong></p>
<ol type="1">
<li>Update your sources, <code>sudo apt-get update</code></li>
<li>Install NetworkManager, <code>sudo apt-get install network-manager</code>. This will install a number of other packages as well.</li>
<li>Install links text-based browser to confirm on captive portals, <code>sudo apt-get install links</code>.</li>
<li>NetworkManager does not manage any interface defined in /etc/network/interfaces by default. The easiest way to manage some interfaces using NetworkManager is to comment them out. <code>sudo nano /etc/network/interfaces</code>.</li>
</ol>
<pre><code>auto lo
iface lo inet loopback

# Managed by NetworkManager
#iface eth0 inet manual

# Managed by NetworkManager
#auto wlan0
#allow-hotplug wlan0
#iface wlan0 inet dhcp
#    wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf</code></pre>
<ul>
<li>Review the <code>sudo nano /etc/NetworkManager/NetworkManager.conf</code> file. It should look similar to this. The previous <em>interfaces</em> file combined with the <em>managed=false</em> setting, informs NetworkManager to only manage interfaces that are not listed in <em>interfaces</em>.</li>
</ul>
<pre><code>[main]
plugins=ifupdown,keyfile

[ifupdown]
managed=false</code></pre>
<ol type="1">
<li>Reboot, <code>sudo reboot now</code>.</li>
<li>Check network connection status, <code>ifconfig wlan0</code> and verify that the inet addr is empty.</li>
<li>Start using nmcli by scanning the manual, <code>man nmcli</code>.</li>
<li>There are 5 Objects but mainly, this guide uses <em>connection</em> and <em>device</em>. Learn more about these by, <code>nmcli con help</code> and <code>nmcli dev help</code>.</li>
<li><code>nmcli dev status</code> displays a table. Notice that wlan0 is disconnected.</li>
<li><code>nmcli dev wifi</code> displays a table of available wifi access points.</li>
<li>Connects may be added using nmcli, for example <code>nmcli con add con-name HOMEOFFICE ifname wlan0 type wifi ssid MYSSID</code>, but I prefer to use nmtui.</li>
<li><code>sudo nmtui</code> provides a text user interface that allows easy creation of wifi connection.</li>
<li>Edit a connection.</li>
<li>Add &gt;&gt; wifi</li>
<li>Give your connection a name and set the fields needed for your access point.</li>
<li>If you provided all the settings correctly and set the connection to connect automatically, it might already have connected. Check with <code>ifconfig wlan0</code>.</li>
<li>Notice the changed out put from <code>nmcli dev status</code> and <code>nmcli dev wifi</code>.</li>
<li>Show active connections with <code>nmcli con show -a</code>.</li>
<li>Take down a connection with <code>sudo nmcli con down connection_name</code> and bring it back up with <code>sudo nmcli con up connection_name</code>.</li>
</ol>
<p>Learn more about NetworkManager and nmcli from these,</p>
<ul>
<li><a href="https://www.mankier.com/1/nmcli">Man nmcli</a></li>
<li><a href="https://www.mankier.com/5/nmcli-examples">Man nmcli examples</a></li>
<li><a href="https://blogs.gnome.org/dcbw/2015/02/16/networkmanager-for-administrators-part-1/">NetworkManager for Administrators</a></li>
<li><a href="https://wiki.archlinux.org/index.php/NetworkManager">Archlinux</a></li>
<li><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/sec-Using_the_NetworkManager_Command_Line_Tool_nmcli.html">Redhat</a></li>
</ul>
<p>NetworkManager service control is via systemctl, therefore it may be enabled with <code>sudo systemctl enable NetworkManager</code> and disabled with <code>sudo systemctl disable NetworkManager</code>. The service may also be monitored using <code>sudo service NetworkManager [status|start|stop|reload|restart]</code>.</p>
<hr />
</section>
<section id="add-the-adafruit-raspberry-pi-repository" class="level2">
<h2><a name="13"></a>Add the Adafruit Raspberry Pi repository</h2>
<p>(optional) The <a href="https://learn.adafruit.com/apt-adafruit-com/overiew">Adafruit repository</a> provides access to the most recent node packages and to a few other goodies useful to makers.</p>
<ol type="1">
<li>Become root, <code>sudo -i</code>.</li>
<li>Add the repository to the sources file, <code>echo &quot;deb http://apt.adafruit.com/raspbian/ release main&quot; &gt;&gt; /etc/apt/sources.list</code>. Replace <em>release</em> with the current stable release. In Jan2016, it is jessie.</li>
<li>Add the repository key, <code>wget -O - -q https://apt.adafruit.com/apt.adafruit.com.gpg.key | apt-key add -</code>.</li>
<li><code>apt-get update</code>.</li>
<li>Exit root, <code>exit</code>.</li>
</ol>
<hr />
</section>
<section id="install-node.js" class="level2">
<h2><a name="14"></a>Install node.js</h2>
<p>(optional) Node.js is a JavaScript runtime environment for developing server-side Web applications. It uses an asynchronous event driven framework that is designed to build scalable network applications. I install it on nearly all of my pi to provide a framework for building user interfaces that can actually do something. <em>(requires Adafruit Raspberry Pi repository)</em></p>
<ol type="1">
<li>Update, <code>sudo apt-get update</code>.</li>
<li>Install node, <code>sudo apt-get install node</code>.</li>
<li>Now go learn more about node from <a href="https://nodejs.org/en/">Node</a>, <a href="http://expressjs.com/en/starter/hello-world.html">Express</a>, <a href="https://learn.adafruit.com/node-embedded-development/events">Adafruit</a>, and <a href="https://www.google.com/webhp?q=node.js%20raspberry%20pi">search</a>.</li>
</ol>
<hr />
</section>
<section id="install-occidentalis" class="level2">
<h2><a name="15"></a>Install occidentalis</h2>
<p>(optional) Occidentalis is a collection of drivers, configuration utilities, and other useful things for single-board computers from <a href="https://github.com/adafruit/Adafruit-Occidentalis">Adafruit</a>. <em>(requires Adafruit Raspberry Pi repository)</em></p>
<ol type="1">
<li>Update, <code>sudo apt-get update</code>.</li>
<li>Install occidentalis, <code>sudo apt-get install occidentalis</code>.</li>
</ol>
<hr />
</section>
</section>
<section id="save-the-image-to-a-file" class="level1">
<h1><a name="Conclusion"></a>Save the image to a file</h1>
<p>Now that you have spent all this time getting your Raspberry Pi set up just so, <strong>save it to an image</strong> for easy reuse. You will still have to change things like usernames, passwords, and hostnames.</p>
<p>Instead of writing a file image to the MicroSD, use the same software to read the MicroSD to a file image. Then when you are ready to spin up your next pi, it will be as easy as, well, pie.</p>
</section>
            </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
    <footer class="inner">
        <p>Published with <a href="http://pandoc.org/">Pandoc</a> onto
        <a href="https://pages.github.com">GitHub Pages</a></p>
    </footer>
    </div>

</body>
</html>
