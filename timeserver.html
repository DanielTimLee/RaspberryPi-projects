<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<meta name="description" content="This time server is built on a Raspberry Pi. It includes a GPS reference and a Kismet wifi scanner.">
<meta name="keywords" content="raspberrypi, guide, time, gps, kismet, ids, ntp, reference">
<meta name="author" content="Gary Dalton">
<title>Timeserver on Raspberry Pi</title>
<link rel="stylesheet" href="stylesheets/github.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="stylesheets/coderay-asciidoctor.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Timeserver on Raspberry Pi</h1>
<div class="details">
<span id="author" class="author">Gary Dalton</span><br>
<span id="email" class="email"><a href="https://github.com/gary-dalton" class="bare">https://github.com/gary-dalton</a></span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">30 October 2016</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_requirements">Requirements</a></li>
<li><a href="#_parts_list">Parts List</a></li>
<li><a href="#_connections">Connections</a></li>
<li><a href="#_gps_and_time_services">GPS and Time Services</a></li>
<li><a href="#_kismet">Kismet</a></li>
<li><a href="#_timeserver_code">Timeserver Code</a></li>
<li><a href="#_launch_on_boot">Launch on Boot</a></li>
<li><a href="#_ntp">NTP</a></li>
<li><a href="#_references">References</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="index.html">Raspberry Pi Projects</a> | <a href="https://gary-dalton.github.io/">Home</a></p>
</div>
<div class="paragraph">
<p>This time server is built on a Raspberry Pi. It includes a GPS reference and a Kismet wifi scanner.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/gary-dalton/RaspberryPi-projects/tree/gh-pages">View on GitHub <span class="image"><img src="images/GitHub-Mark-32px.png" alt="GitHub Mark 32px"></span></a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_requirements">Requirements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide starts with a basic Raspbian Lite build, connected to a wired network. Follow the <a href="rpi_initial_setup.html">RPi Initial Setup Guide</a> to get started. A Raspberry Pi 2 or 3 may be used.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_parts_list">Parts List</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Raspberry Pi 2 or 3</p>
</li>
<li>
<p>8GB (or larger) class 10 MicroSD card</p>
</li>
<li>
<p>GPS breakout (<a href="https://www.adafruit.com/product/746">Adafruit Ultimate GPS Breakout - 66 channel w/10 Hz updates - Version 3</a>)</p>
</li>
<li>
<p><a href="https://www.adafruit.com/products/960">External GPS antenna</a> and <a href="https://www.adafruit.com/products/851">SMA to u.FL adapter cable</a></p>
</li>
<li>
<p>USB Wifi with monitor mode (<a href="https://smile.amazon.com/dp/B002SZEOLG">TP-Link WN722N WiFi</a>)(see <a href="rpi_which_wifi_usb.html">Which Wifi USB</a>)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_connections">Connections</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Connect</strong> wires from the GPS breakout to the pi.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>VIN to GPIO 5V pin 04</p>
</li>
<li>
<p>GND to GPIO GND pin 06</p>
</li>
<li>
<p>RX to GPIO TXD0 pin 08</p>
</li>
<li>
<p>TX to GPIO RXD0 pin 10</p>
</li>
<li>
<p>PPS to GPIO 27 pin 13 (to output timing PPS, for accurate clock)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Connect</strong> a pushbutton to the pi.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pin 1 to GND</p>
</li>
<li>
<p>Pin 2 to GPIO 17 pin 11</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/timeserver_bb.png" alt="timeserver bb"></span></p>
</div>
<div class="paragraph">
<p><strong>Connect</strong> a rooftop antenna via the SMA to u.FL adapter.</p>
</div>
<div class="paragraph">
<p><strong>Connect</strong> a monitor mode capable USB wifi with external antenna.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_gps_and_time_services">GPS and Time Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Set up GPS and Time Services as shown in <a href="rpi3_gps.html">GPS on Raspberry Pi 3</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_kismet">Kismet</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Set up Kismet as shown in <a href="rpi3_kismet.html">Kismet on Raspberry Pi</a>. The optional GISKismet is not needed.</p>
</div>
<div class="paragraph">
<p>For IDS purposes, the more interesting log files are those which track the alerts. Validating the client MAC addresses attached to your own access points is also worthwhile.</p>
</div>
<div class="paragraph">
<p>The various Kismet alerts are documented at <a href="http://kismetwireless.net/documentation.shtml" class="bare">http://kismetwireless.net/documentation.shtml</a> under <em>Alerts and IDS</em>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_timeserver_code">Timeserver Code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The timeserver.py is intended to be launched at startup. It provides an easy to use shutdown button and starts Kismet when the system is ready.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sudo apt-get update</code></p>
</li>
<li>
<p><code>sudo apt-get install git</code></p>
</li>
<li>
<p><code>mkdir ~/github</code></p>
</li>
<li>
<p><code>cd ~/github</code></p>
</li>
<li>
<p><code>git clone <a href="https://github.com/gary-dalton/RaspberryPi-projects.git" class="bare">https://github.com/gary-dalton/RaspberryPi-projects.git</a></code></p>
</li>
<li>
<p><code>cd RaspberryPi-projects/timeserver</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">timeserver.py</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment">#!/bin/python</span>
<span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">timeserver.py: main timeserver startup script</span><span class="content">
</span><span class="content">Provides a shutdown button and starts Kismet after a GPS fix.</span><span class="content">
</span><span class="delimiter">&quot;&quot;&quot;</span></span>

<span class="keyword">import</span> <span class="include">RPi.GPIO</span> <span class="keyword">as</span> GPIO
<span class="keyword">import</span> <span class="include">time</span>, <span class="include">datetime</span>, <span class="include">logging</span>
<span class="keyword">import</span> <span class="include">gps</span>


<span class="comment"># Configure logging</span>
logfilename=<span class="string"><span class="delimiter">'</span><span class="content">/var/log/timeserver.log</span><span class="delimiter">'</span></span>
logformat = <span class="string"><span class="delimiter">'</span><span class="content">%(asctime)s - %(levelname)s - %(message)s</span><span class="delimiter">'</span></span>
logging.basicConfig(format=logformat, filename = logfilename, level=logging.DEBUG)

<span class="comment"># Use the Board Pin numbers</span>
GPIO.setmode(GPIO.BOARD)

<span class="comment"># Pins</span>
BUTTON_SHUTDOWN = <span class="integer">11</span>

<span class="comment"># Setup the Pin with Internal pullups enabled and PIN in reading mode.</span>
GPIO.setup(BUTTON_SHUTDOWN, GPIO.IN, pull_up_down=GPIO.PUD_UP)

<span class="keyword">def</span> <span class="function">shutdown</span>(channel):
    <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">    Calls system shutdown after a button press of more than 2 seconds</span><span class="content">
</span><span class="content">    </span><span class="delimiter">&quot;&quot;&quot;</span></span>
    GPIO.remove_event_detect(channel)
    pressed_time = datetime.datetime.now()
    <span class="keyword">while</span> <span class="keyword">not</span> GPIO.input(channel):
        time.sleep(<span class="float">.5</span>)
    dif = datetime.datetime.now() - pressed_time
    pressed_time = dif.seconds
    logging.debug(<span class="string"><span class="delimiter">'</span><span class="content">Pressed time = %s</span><span class="delimiter">'</span></span>, pressed_time)
    <span class="keyword">if</span> pressed_time &gt; <span class="integer">2</span>:
        logging.info(<span class="string"><span class="delimiter">'</span><span class="content">Button initiated shutdown</span><span class="delimiter">'</span></span>)
        os.system(<span class="string"><span class="delimiter">&quot;</span><span class="content">sudo reboot -h now</span><span class="delimiter">&quot;</span></span>)
    GPIO.add_event_detect(channel, GPIO.FALLING, callback=shutdown, bouncetime=<span class="integer">200</span>)

<span class="comment"># Add button pressed event detects</span>
GPIO.add_event_detect(BUTTON_SHUTDOWN, GPIO.FALLING, callback=shutdown, bouncetime=<span class="integer">2000</span>)

<span class="keyword">def</span> <span class="function">main</span>():
    <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">Timeserver Main</span><span class="delimiter">&quot;&quot;&quot;</span></span>
    <span class="comment"># Check for valid GPS fix (mode == 3) before loading kismet</span>
    session = gps.gps(mode=gps.WATCH_ENABLE)
    report = session.next()
    <span class="keyword">while</span> report[<span class="string"><span class="delimiter">'</span><span class="content">class</span><span class="delimiter">'</span></span>] != <span class="string"><span class="delimiter">'</span><span class="content">TPV</span><span class="delimiter">'</span></span>:
        report = session.next()
    <span class="keyword">while</span> report.mode != <span class="integer">3</span>:
        time.sleep(<span class="integer">5</span>)
        report = session.next()

    <span class="comment"># Start Kismet</span>
    logging.info(<span class="string"><span class="delimiter">'</span><span class="content">GPS mode 3 fix achieved</span><span class="delimiter">'</span></span>)
    os.system(<span class="string"><span class="delimiter">'</span><span class="content">/usr/local/bin/kismet_server --daemonize</span><span class="delimiter">'</span></span>)
    logging.info(<span class="string"><span class="delimiter">'</span><span class="content">Kismet server started</span><span class="delimiter">'</span></span>)

    <span class="comment"># Loop until shutdown</span>
    <span class="keyword">while</span> <span class="predefined-constant">True</span>:
        time.sleep(<span class="integer">10</span>)

<span class="keyword">if</span> __name__ == <span class="string"><span class="delimiter">&quot;</span><span class="content">__main__</span><span class="delimiter">&quot;</span></span>:
    main()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_launch_on_boot">Launch on Boot</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Crontab is used to launch the timeserver.py on boot.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sudo crontab -e</code></p>
</li>
<li>
<p>Add at end of file</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>@reboot python /home/pi/github/RaspberryPi-projects/timeserver/timeserver.py &amp;</pre>
</div>
</div>
<div class="paragraph">
<p>Check that your script is running:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Logfile, <code>grep 'CRON' /var/log/syslog</code>. The last line show the script being run.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>Oct 31 15:26:32 timeserver cron[389]: (CRON) INFO (pidfile fd = 3)
Oct 31 15:26:32 timeserver cron[389]: (CRON) INFO (Running @reboot jobs)
Oct 31 15:26:32 timeserver CRON[460]: (root) CMD (python /home/pi/github/RaspberryPi-projects/timeserver/timeserver.py &amp;)</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Process, <code>ps aux | grep timeserver.py</code>. Show the process running. For this instance, the PID is <em>462</em>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>root       462  0.0  0.9  21004  8896 ?        Sl   15:26   0:00 python /home/pi/github/RaspberryPi-projects/timeserver/timeserver.py</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Kill process if needed, <code>sudo kill 462</code>. Replace <em>462</em> with your PID.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ntp">NTP</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our current NTP configuration does not serve time to clients.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references">References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="http://raspberrywebserver.com/serveradmin/run-a-script-on-start-up.html" class="bare">http://raspberrywebserver.com/serveradmin/run-a-script-on-start-up.html</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2016-10-31 18:59:28 Central Daylight Time
</div>
</div>
</body>
</html>